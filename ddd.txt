(
	
	fn AddObj = (
		-- Boxにカスタムアトリビュートを追加する
		ca_test = attributes "MyCustomProps"
		(
			parameters main rollout:params
			(
				mySize type:#float ui:spn_size default:10.0
			)
			rollout params "ノード固有の属性"
			(
				spinner spn_size "サイズ係数: "range:[-1.0e+9,1.0e+9, 0]
			)
			
		)

		b = box name:"TestBox_with_CA"
		--custAttributes.add b ca_test	
			

		local m = EmptyModifier()
		addModifier b m
		custAttributes.add m ca_test

		return b
	)
	
	b = AddObj()
		
	
	
	-- 1. カスタムアトリビュートの定義
	myExtraParams = attributes "SwitchingUI_v2"
	(
		local DescStride = 1 
		local MyCustomPropsDesc =
		#(
			-- ca name --
			"MyCustomProps",
			-- rollout name --
			"params",
			-- control enabled status --　　--visibility
			#("spn_size", false)
			--#("btn_create", false),
			--#("btn_del", true)
		)

		
		parameters main rollout:params
		(
			
			width type:#float default:10.0 ui:spn_float
			
			-- ドロップダウンの選択状態（数値）を保存
			selectedType type:#integer default:1 ui:ddl_type
			
			m_SubrolloutNodes type:#maxObjectTab tabSizeVariable:true
			m_ModIndices type:#intTab tabSizeVariable:true
			
			on selectedType set val do this.params.updateSubUI val

		)
		
		

		rollout params "Params"
		(
			rollout roll_A "Base" ( spinner spn_size "Size:" )
			rollout roll_B "Extra" ( colorPicker clr_wire "Color:" )
			
			spinner spn_float "width: " range:[-1.0e+9,1.0e+9, 0]
			
			dropdownList ddl_type "表示モードを選択:" items:#("Base", "Extra", "???")
			subRollout sub_container "Sub" height:100
			
			

			fn InitSubrollout n mod_idx desc =
			(
				try(
					
--TODO: モディファイヤ1番目とは限らない
					local ca = getProperty n.modifiers[mod_idx] desc[1] --
					local ro = getProperty ca desc[2]-- 文字列指定もOK
					
					-- Add subrollout
					addSubRollout sub_container ro
					
					-- Change enable/disable
					for i=3 to desc.count do
					(
						local ctrl = getProperty ro desc[i][1]
						ctrl.enabled = desc[i][2] --ctrl.visible 
					)
					
				) catch ( format "Error occured: %\n" (getCurrentExceptionStackTrace()) )
			)
			
			
			fn AttachSubRollout =
			(
					for i=1 to m_SubrolloutNodes.count by DescStride do
					(
						-- 
						local n = m_SubrolloutNodes[i].node
						if isValidNode n do ( InitSubrollout n m_ModIndices[i] MyCustomPropsDesc )
						
						--
					)
			)
			
			
			-- サブロールアウト更新関数
			fn updateSubUI val =
			(
				--try (
					if params.open and sub_container != undefined do
					(
						-- Clear existing rollouts
						for r in sub_container.rollouts do removeSubRollout sub_container r
						
						-- Reattach sub rollout
						if val == 1 then addSubRollout sub_container roll_A
						else if val == 2 then addSubRollout sub_container roll_B
						/*
						else if val == 3 then
						(
							local ca = getAnimByHandle ca_handle
							if ca != undefined then
							(
								addSubRollout sub_container ca.params
							)
							else
							(
								format "cannot find CA\n"
							)
						)*/
						else if val==3 then
						(
							AttachSubRollout()
							--InitSubrollout()
							
							/*
							for ca in sub_contents do(
								
								--local ro = ca.params --OK
								local ro = getProperty ca "params"-- 文字列指定もOK
								
								addSubRollout sub_container ro --CAを渡すのはOK
								ro.spn_size.visible = false -- これもOK. この書き方をする
								
								local theControl = getProperty ro "spn_size"-- これもOK. 文字列で名前指定してコントローラーを取得できる
								theControl.visible = false
								
								format "Added sub_rollout: %\n" ro.name theControl.value
							)
							*/
							/*
							for ro in sub_contents do
							(
								--ro.spn_size.visible = false
								addSubRollout sub_container ro -- rolloutを直接渡すのはNG
							)
							*/
								
						)
						
					)
				--) catch (
					-- Do nothing if error occured
				--)
				
			)
			
			
			-- timer to delay "on params open" initialization process ---
			-- this avoids "rubber-band select->Delete" mulfunction of dropdownList/subRollout rollout
			timer delay_timer interval:100 active:false
			on delay_timer tick do -- Do initialization
			(
				if sub_container.rollouts.count == 0 do updateSubUI this.selectedType -- delay execution after 100ms
				delay_timer.active = false
			)			
			--------------------------------------------------
			
			on params open do
			(
				delay_timer.active = true -- ignite delay initialization
			)	
			
			on params close do
			(
				for r in sub_container.rollouts do removeSubRollout sub_container r
			)
			
		)
		
		
	)
	
	

	

	-- 選択しているオブジェクトに適用する
	p = Point()
	custAttributes.add p myExtraParams-- もしオブジェクト自体に追加するなら:
	
	
		-- rolloutを直接渡すのはNG. カスタムアトリビュートまでなら安全
	
	-- カスタムアトリビュートを直接渡す ----------------------------- OK
	--append p.SwitchingUI_v2.sub_contents b.modifiers[1].MyCustomProps
	
	-- カスタムアトリビュート内部のrolloutを直接渡すのは ----------------------- NG
	--append p.SwitchingUI_v2.sub_contents b.modifiers[1].MyCustomProps.params
	
	-- カスタムアトリビュート内部のrolloutを直接渡すのは(2) ----------------------- NG
	--append p.SwitchingUI_v2.sub_contents (getProperty b.modifiers[1].MyCustomProps #params)
	

	--サブロールアウト参照元CAのノード参照を登録する
	append p.SwitchingUI_v2.m_SubrolloutNodes (nodeTransformMonitor node:b forwardTransformMessages:false)


--ノードにモディファイヤが複数アタッチされている場合、どのモディファイヤのCAなのかが分からない。
append p.SwitchingUI_v2.m_ModIndices (findItem b.modifiers b.modifiers[1])
-- CA毎にノード参照は登録する
-- CA毎にモディファイヤインデックスも登録する

	
	
	local sCtrl = float_script()
	b.modifiers[1].MyCustomProps.mySize.controller =  sCtrl--    p.SwitchingUI_v2.with = sCtrl--ctrlBox.pos.controller.Z_Position.controller = sCtrl

	-- 4. 変数の登録（ここが重要！）
	-- masterSphereのカスタムアトリビュートの「トラック」を直接参照させる
	--sCtrl.addNode "masterNode" masterSphere
	
	sCtrl.AddObject "masterCA" p.SwitchingUI_v2
	
	-- 変数として特定のトラックを割り当てる方法（より安全）
	sCtrl.addTarget "myInput" p.baseObject.SwitchingUI_v2[#width] --masterSphere.baseObject.MyData[#val]

	-- 5. 複雑なロジックを記述
	local scriptString = ""
	/*
	scriptString += "local baseVal = myInput\n" -- 登録した変数を使用
	scriptString += "if baseVal > 50 then (\n"
	scriptString += "    (sin(currenttime.ticks / 10.0)) * 20 + baseVal\n" -- 50を超えると揺れる
	scriptString += ") else (\n"
	scriptString += "    baseVal * 0.5\n" -- 50以下なら半分の値
	scriptString += ")"
	*/
	
	scriptString += "local baseVal = myInput\n" -- 登録した変数を使用
	scriptString += "return baseVal * 0.5\n" -- 50以下なら半分の値
	
	sCtrl.script = scriptString	
	
)